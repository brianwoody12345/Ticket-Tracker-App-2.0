<!DOCTYPE html>
<html lang="en">
    
<head>
<link rel="canonical" href="https://ticket-tracker-app-zg81.vercel.app/">

<meta property="og:type" content="website">
<meta property="og:site_name" content="Raffle Ticket Tracker">
<meta property="og:title" content="Ticket Tracker by Woody Calculus">
<meta property="og:description" content="Track, draw, and celebrate winners — with confetti and cheers!">
<meta property="og:url" content="https://ticket-tracker-app-zg81.vercel.app/">
<meta property="og:image" content="https://ticket-tracker-app-zg81.vercel.app/thumbnail.png?v=10">
<meta property="og:image:secure_url" content="https://ticket-tracker-app-zg81.vercel.app/thumbnail.png?v=10">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Ticket Tracker by Woody Calculus">
<meta name="twitter:description" content="Track, draw, and celebrate winners — with confetti and cheers!">
<meta name="twitter:image" content="https://ticket-tracker-app-zg81.vercel.app/thumbnail.png?v=10">

    <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raffle Ticket Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .app-credit {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .draw-name-input {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            width: 300px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-mode-toggle {
            display: flex;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #3498db;
            color: white;
        }

        .range-input, .ticket-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .range-input input, .ticket-input input,
        .range-input select, .ticket-input select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            flex: 1;
            min-width: 120px;
        }

        /* Color-specific styles for dropdown options */
        .color-red { color: #e74c3c; }
        .color-blue { color: #3498db; }
        .color-green { color: #27ae60; }
        .color-yellow { color: #f39c12; }
        .color-purple { color: #9b59b6; }
        .color-orange { color: #e67e22; }
        .color-pink { color: #e91e63; }
        .color-brown { color: #795548; }
        .color-black { color: #2c3e50; }
        .color-gray { color: #7f8c8d; }
        .color-teal { color: #009688; }
        .color-navy { color: #34495e; }

        .range-input button, .ticket-input button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .range-input button:hover, .ticket-input button:hover {
            background: #2980b9;
        }

        .ranges-display h3 {
            color: #34495e;
            margin-bottom: 15px;
        }

        .color-sections {
            display: grid;
            gap: 15px;
        }

        .color-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        /* Color-specific border colors */
        .color-section.red { border-left-color: #e74c3c; }
        .color-section.blue { border-left-color: #3498db; }
        .color-section.green { border-left-color: #27ae60; }
        .color-section.yellow { border-left-color: #f39c12; }
        .color-section.purple { border-left-color: #9b59b6; }
        .color-section.orange { border-left-color: #e67e22; }
        .color-section.pink { border-left-color: #e91e63; }
        .color-section.brown { border-left-color: #795548; }
        .color-section.black { border-left-color: #2c3e50; }
        .color-section.gray { border-left-color: #7f8c8d; }
        .color-section.teal { border-left-color: #009688; }
        .color-section.navy { border-left-color: #34495e; }

        .color-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
        }

        /* Color-specific text colors */
        .color-header.red { color: #e74c3c; }
        .color-header.blue { color: #3498db; }
        .color-header.green { color: #27ae60; }
        .color-header.yellow { color: #f39c12; }
        .color-header.purple { color: #9b59b6; }
        .color-header.orange { color: #e67e22; }
        .color-header.pink { color: #e91e63; }
        .color-header.brown { color: #795548; }
        .color-header.black { color: #2c3e50; }
        .color-header.gray { color: #7f8c8d; }
        .color-header.teal { color: #009688; }
        .color-header.navy { color: #34495e; }

        .range-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #ecf0f1;
            border-radius: 5px;
            border-left: 3px solid;
        }

        /* Color-specific range item borders */
        .range-item.red { border-left-color: #e74c3c; }
        .range-item.blue { border-left-color: #3498db; }
        .range-item.green { border-left-color: #27ae60; }
        .range-item.yellow { border-left-color: #f39c12; }
        .range-item.purple { border-left-color: #9b59b6; }
        .range-item.orange { border-left-color: #e67e22; }
        .range-item.pink { border-left-color: #e91e63; }
        .range-item.brown { border-left-color: #795548; }
        .range-item.black { border-left-color: #2c3e50; }
        .range-item.gray { border-left-color: #7f8c8d; }
        .range-item.teal { border-left-color: #009688; }
        .range-item.navy { border-left-color: #34495e; }

        .range-item span {
            flex: 1;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .range-item button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .ticket-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Color-specific ticket borders */
        .ticket-item.red { border-left-color: #e74c3c; }
        .ticket-item.blue { border-left-color: #3498db; }
        .ticket-item.green { border-left-color: #27ae60; }
        .ticket-item.yellow { border-left-color: #f39c12; }
        .ticket-item.purple { border-left-color: #9b59b6; }
        .ticket-item.orange { border-left-color: #e67e22; }
        .ticket-item.pink { border-left-color: #e91e63; }
        .ticket-item.brown { border-left-color: #795548; }
        .ticket-item.black { border-left-color: #2c3e50; }
        .ticket-item.gray { border-left-color: #7f8c8d; }
        .ticket-item.teal { border-left-color: #009688; }
        .ticket-item.navy { border-left-color: #34495e; }

        .ticket-item.winner {
            background: #d4edda;
        }

        .ticket-item.loser {
            background: #f8d7da;
        }

        .ticket-info {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            flex-wrap: wrap;
        }

        .ticket-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .ticket-color {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-transform: uppercase;
        }

        /* Color-specific ticket color badges */
        .ticket-item.red .ticket-color { background: #e74c3c; }
        .ticket-item.blue .ticket-color { background: #3498db; }
        .ticket-item.green .ticket-color { background: #27ae60; }
        .ticket-item.yellow .ticket-color { background: #f39c12; }
        .ticket-item.purple .ticket-color { background: #9b59b6; }
        .ticket-item.orange .ticket-color { background: #e67e22; }
        .ticket-item.pink .ticket-color { background: #e91e63; }
        .ticket-item.brown .ticket-color { background: #795548; }
        .ticket-item.black .ticket-color { background: #2c3e50; }
        .ticket-item.gray .ticket-color { background: #7f8c8d; }
        .ticket-item.teal .ticket-color { background: #009688; }
        .ticket-item.navy .ticket-color { background: #34495e; }

        .ticket-mode {
            font-size: 0.8em;
            color: #7f8c8d;
            font-style: italic;
        }

        .ticket-time {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .ticket-result {
            font-weight: bold;
            margin: 0 15px;
            text-align: center;
        }

        .ticket-item.winner .ticket-result {
            color: #28a745;
        }

        .ticket-item.loser .ticket-result {
            color: #dc3545;
        }

        .winning-numbers {
            font-size: 0.8em;
            font-weight: normal;
            margin-top: 5px;
            color: #1e7e34;
        }

        .delete-ticket {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .clear-all-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 25px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .clear-all-btn:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

</head>
<body>
    <div class="app">
        <header class="app-header">
            <h1>🎟️ Raffle Ticket Tracker</h1>
            <div class="app-credit">by Woody Calculus</div>
            <input type="text" placeholder="Enter draw name..." class="draw-name-input" id="drawName">
        </header>

        <div class="container">
            <!-- Add Ranges Section -->
            <div class="section">
                <h2>Add Your Ticket Ranges</h2>
                <div class="range-input">
                    <select id="rangeColor">
                        <option value="red" class="color-red">Red</option>
                        <option value="blue" class="color-blue">Blue</option>
                        <option value="green" class="color-green">Green</option>
                        <option value="yellow" class="color-yellow">Yellow</option>
                        <option value="purple" class="color-purple">Purple</option>
                        <option value="orange" class="color-orange">Orange</option>
                        <option value="pink" class="color-pink">Pink</option>
                        <option value="brown" class="color-brown">Brown</option>
                        <option value="black" class="color-black">Black</option>
                        <option value="gray" class="color-gray">Gray</option>
                        <option value="teal" class="color-teal">Teal</option>
                        <option value="navy" class="color-navy">Navy</option>
                    </select>
                    <input type="text" placeholder="Start number" id="rangeStart">
                    <input type="text" placeholder="End number" id="rangeEnd">
                    <button onclick="addRange()">Add Range</button>
                </div>

                <!-- Display Ranges -->
                <div class="ranges-display">
                    <h3>Your Ticket Ranges</h3>
                    <div class="color-sections" id="colorSections">
                        <div class="empty-state">No ticket ranges added yet. Add your first range above!</div>
                    </div>
                </div>
            </div>

            <!-- Called Tickets Section -->
            <div class="section">
                <h2>Called Tickets</h2>
                
                <!-- Input Mode Toggle -->
                <div class="input-mode-toggle">
                    <button class="toggle-btn active" onclick="setInputMode('full')">Full Number</button>
                    <button class="toggle-btn" onclick="setInputMode('lastThree')">Last 3 Digits</button>
                </div>

                <div class="ticket-input">
                    <select id="ticketColor">
                        <option value="">No colors available</option>
                    </select>
                    
                    <input type="text" placeholder="Full ticket number" id="ticketNumber">
                    <input type="text" placeholder="Last 3 digits" id="ticketLastThree" style="display: none;" maxlength="3">
                    
                    <button onclick="addCalledTicket()">Add Called Ticket</button>
                </div>

                <!-- Display Called Tickets -->
                <div class="called-tickets" id="calledTickets">
                    <div class="empty-state">No tickets called yet. Add called tickets above!</div>
                </div>
            </div>
        </div>

        <button onclick="clearAll()" class="clear-all-btn">Clear All Data</button>
    </div>

    <script>
        // Available colors with their display names
        const availableColors = {
            red: 'Red',
            blue: 'Blue', 
            green: 'Green',
            yellow: 'Yellow',
            purple: 'Purple',
            orange: 'Orange',
            pink: 'Pink',
            brown: 'Brown',
            black: 'Black',
            gray: 'Gray',
            teal: 'Teal',
            navy: 'Navy'
        };

        let ranges = {}; // Start completely empty - no preloaded ranges!
        let calledTickets = [];
        let currentInputMode = 'full';

        // Load from localStorage
        function loadData() {
            const savedRanges = localStorage.getItem('raffleRanges');
            const savedTickets = localStorage.getItem('calledTickets');
            const savedDrawName = localStorage.getItem('drawName');
            
            if (savedRanges) ranges = JSON.parse(savedRanges);
            if (savedTickets) calledTickets = JSON.parse(savedTickets);
            if (savedDrawName) document.getElementById('drawName').value = savedDrawName;
            
            updateDisplay();
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('raffleRanges', JSON.stringify(ranges));
            localStorage.setItem('calledTickets', JSON.stringify(calledTickets));
            localStorage.setItem('drawName', document.getElementById('drawName').value);
        }

        function formatTicketNumber(num) {
            const numStr = num.toString();
            if (numStr.length <= 3) {
                return numStr;
            }
            // Add dash before last 3 digits
            const prefix = numStr.slice(0, -3);
            const lastThree = numStr.slice(-3);
            return `${prefix}-${lastThree}`;
        }

        function addRange() {
            const color = document.getElementById('rangeColor').value;
            const start = document.getElementById('rangeStart').value.replace(/\D/g, '');
            const end = document.getElementById('rangeEnd').value.replace(/\D/g, '');
            const startNum = parseInt(start);
            const endNum = parseInt(end);
            
            if (!start || !end || startNum > endNum) {
                alert('Please enter valid start and end numbers');
                return;
            }

            if (!ranges[color]) {
                ranges[color] = [];
            }
            
            ranges[color].push({ start: startNum, end: endNum });
            document.getElementById('rangeStart').value = '';
            document.getElementById('rangeEnd').value = '';
            saveData();
            updateDisplay();
        }

       function setInputMode(mode, evt) {
  currentInputMode = mode;

  // Toggle active styles safely (works with or without an event)
  const buttons = document.querySelectorAll('.input-mode-toggle .toggle-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  if (evt && evt.target) {
    evt.target.classList.add('active');
  } else {
    const fullBtn = [...buttons].find(b => /Full Number/i.test(b.textContent));
    const last3Btn = [...buttons].find(b => /Last 3/i.test(b.textContent));
    (mode === 'full' ? fullBtn : last3Btn)?.classList.add('active');
  }

  // Show/hide inputs
  const full = document.getElementById('ticketNumber');
  const last = document.getElementById('ticketLastThree');
  if (mode === 'full') {
    full.style.display = 'block';
    last.style.display = 'none';
  } else {
    full.style.display = 'none';
    last.style.display = 'block';
  }
}


        function addCalledTicket() {
            const color = document.getElementById('ticketColor').value;
            
            if (!color) {
                alert('Please add ticket ranges first before calling tickets');
                return;
            }
            
            let ticketData = {};
            
            if (currentInputMode === 'full') {
                const number = document.getElementById('ticketNumber').value.replace(/\D/g, '');
                const ticketNum = parseInt(number);
                if (!ticketNum && ticketNum !== 0) {
                    alert('Please enter a valid ticket number');
                    return;
                }
                ticketData = {
                    number: ticketNum,
                    fullNumber: ticketNum,
                    lastThree: null,
                    inputMode: 'full'
                };
            } else {
                const lastThree = document.getElementById('ticketLastThree').value.padStart(3, '0');
                if (lastThree.length !== 3 || !/^\d+$/.test(lastThree)) {
                    alert('Please enter exactly 3 digits for the last three numbers');
                    return;
                }
                ticketData = {
                    number: lastThree,
                    fullNumber: null,
                    lastThree: lastThree,
                    inputMode: 'lastThree'
                };
            }

            ticketData.color = color;
            ticketData.timestamp = new Date().toLocaleTimeString();
            
            calledTickets.unshift(ticketData);
            document.getElementById('ticketNumber').value = '';
            document.getElementById('ticketLastThree').value = '';
            saveData();
            updateDisplay();
        }

        function isWinningTicket(ticket) {
            const colorRanges = ranges[ticket.color] || [];
            
            if (ticket.inputMode === 'full') {
                return colorRanges.some(range => 
                    ticket.fullNumber >= range.start && ticket.fullNumber <= range.end
                );
            } else {
                return colorRanges.some(range => {
                    for (let num = range.start; num <= range.end; num++) {
                        const numStr = num.toString().padStart(3, '0');
                        const lastThreeDigits = numStr.slice(-3);
                        if (lastThreeDigits === ticket.lastThree) {
                            return true;
                        }
                    }
                    return false;
                });
            }
        }

        function getWinningNumbers(ticket) {
            if (ticket.inputMode !== 'lastThree' || !isWinningTicket(ticket)) {
                return [];
            }

            const colorRanges = ranges[ticket.color] || [];
            const winningNumbers = [];

            colorRanges.forEach(range => {
                for (let num = range.start; num <= range.end; num++) {
                    const numStr = num.toString().padStart(3, '0');
                    const lastThreeDigits = numStr.slice(-3);
                    if (lastThreeDigits === ticket.lastThree) {
                        winningNumbers.push(num);
                    }
                }
            });

            return winningNumbers;
        }

        function deleteRange(color, index) {
            if (ranges[color]) {
                ranges[color].splice(index, 1);
                // Remove color if no ranges left
                if (ranges[color].length === 0) {
                    delete ranges[color];
                }
            }
            saveData();
            updateDisplay();
        }

        function deleteCalledTicket(index) {
            calledTickets.splice(index, 1);
            saveData();
            updateDisplay();
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all data?')) {
                ranges = {}; // Reset to completely empty
                calledTickets = [];
                document.getElementById('drawName').value = '';
                localStorage.removeItem('raffleRanges');
                localStorage.removeItem('calledTickets');
                localStorage.removeItem('drawName');
                updateDisplay();
            }
        }

        function updateDisplay() {
            // Update available colors in ticket color dropdown
            const ticketColorSelect = document.getElementById('ticketColor');
            const colorKeys = Object.keys(ranges).filter(color => ranges[color] && ranges[color].length > 0);
            
            if (colorKeys.length === 0) {
                ticketColorSelect.innerHTML = '<option value="">No colors available</option>';
            } else {
                ticketColorSelect.innerHTML = '';
                colorKeys.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = availableColors[color];
                    option.className = `color-${color}`;
                    ticketColorSelect.appendChild(option);
                });
            }

            // Update ranges display
            const colorSections = document.getElementById('colorSections');
            const colorKeysForDisplay = Object.keys(ranges).filter(color => ranges[color] && ranges[color].length > 0);
            
            if (colorKeysForDisplay.length === 0) {
                colorSections.innerHTML = '<div class="empty-state">No ticket ranges added yet. Add your first range above!</div>';
            } else {
                colorSections.innerHTML = '';
                colorKeysForDisplay.forEach(color => {
                    const section = document.createElement('div');
                    section.className = `color-section ${color}`;
                    
                    const header = document.createElement('div');
                    header.className = `color-header ${color}`;
                    header.innerHTML = `
                        <h4>${availableColors[color]} Tickets</h4>
                    `;
                    
                    const rangesContainer = document.createElement('div');
                    rangesContainer.innerHTML = ranges[color].map((range, index) => `
                        <div class="range-item ${color}">
                            <span>${formatTicketNumber(range.start)} - ${formatTicketNumber(range.end)}</span>
                            <button onclick="deleteRange('${color}', ${index})">×</button>
                        </div>
                    `).join('');
                    
                    section.appendChild(header);
                    section.appendChild(rangesContainer);
                    colorSections.appendChild(section);
                });
            }

            // Update called tickets display
            const calledTicketsContainer = document.getElementById('calledTickets');
            if (calledTickets.length === 0) {
                calledTicketsContainer.innerHTML = '<div class="empty-state">No tickets called yet. Add called tickets above!</div>';
            } else {
                calledTicketsContainer.innerHTML = calledTickets.map((ticket, index) => {
                    const isWinner = isWinningTicket(ticket);
                    const winningNumbers = getWinningNumbers(ticket);
                    
                    return `
                        <div class="ticket-item ${ticket.color} ${isWinner ? 'winner' : 'loser'}">
                            <div class="ticket-info">
                                <span class="ticket-number">
                                    ${ticket.inputMode === 'full' ? formatTicketNumber(ticket.fullNumber) : `XXX-${ticket.lastThree}`}
                                </span>
                                <span class="ticket-color">${availableColors[ticket.color]}</span>
                                <span class="ticket-mode">(${ticket.inputMode === 'full' ? 'full' : 'last 3'})</span>
                                <span class="ticket-time">${ticket.timestamp}</span>
                            </div>
                            
                            <div class="ticket-result">
                                ${isWinner ? `
                                    <div>
                                        <div>🎉 WINNER!</div>
                                        ${ticket.inputMode === 'lastThree' && winningNumbers.length > 0 ? `
                                            <div class="winning-numbers">Matching: ${winningNumbers.map(formatTicketNumber).join(', ')}</div>
                                        ` : ''}
                                    </div>
                                ` : '❌ Not in range'}
                            </div>
                            
                            <button onclick="deleteCalledTicket(${index})" class="delete-ticket">×</button>
                        </div>
                    `;
                }).join('');
            }
        }

        // Initialize
        document.getElementById('drawName').addEventListener('input', saveData);
        loadData();
    </script>
    <script src="./enhancers/win-effects.js"></script>
<audio id="win-sfx" src="./win.mp3" preload="auto" playsinline></audio>
<script src="./enhancers/win-effects.js?v=2"></script>
<script>
/* Single-file confetti + sound (no separate JS or MP3 required) */
(function () {
  const confettiEnabled = localStorage.getItem('confettiEnabled') !== 'false';
  const soundEnabled    = localStorage.getItem('soundEnabled')    !== 'false';
  const celebrated = new Set();

  // ---------- AUDIO ----------
  let audioEl = document.getElementById('win-sfx'); // optional mp3 if you add it later
  let mp3Ok = false;

  function fallbackChime() {
    try {
      const C = window.AudioContext || window.webkitAudioContext;
      if (!C) return;
      const ctx = new C();
      const now = ctx.currentTime;
      const beep = (f, t0, dur, type='triangle', g0=0.0001, g1=0.18)=>{
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type = type; o.frequency.value = f;
        g.gain.setValueAtTime(g0, t0);
        g.gain.exponentialRampToValueAtTime(g1, t0+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
        o.connect(g); g.connect(ctx.destination);
        o.start(t0); o.stop(t0+dur+0.02);
      };
      beep(987.77,  now,      0.18); // B5
      beep(1318.51, now+0.04, 0.18); // E6
    } catch {}
  }

  function playWinSound() {
    if (!soundEnabled) return;
    if (mp3Ok && audioEl) {
      const p = audioEl.play();
      if (p && typeof p.then === 'function') {
        p.catch(() => {
          const once = () => { audioEl.play().catch(fallbackChime); };
          document.body.addEventListener('click', once, { once:true });
          console.log('🔈 Autoplay blocked — will play after next click.');
        });
      }
    } else {
      fallbackChime();
    }
  }

  if (!audioEl) {
    // create an <audio> tag so we can prime autoplay; leave src unset until you add win.mp3
    audioEl = document.createElement('audio');
    audioEl.id = 'win-sfx';
    audioEl.preload = 'auto';
    audioEl.setAttribute('playsinline', '');
    document.body.appendChild(audioEl);
  } else {
    audioEl.addEventListener('canplaythrough', () => { mp3Ok = true; }, { once:true });
    audioEl.addEventListener('error', () => { mp3Ok = false; });
    audioEl.load();
    mp3Ok = !!audioEl.src;
  }

  function primeOnce() {
    if (mp3Ok) audioEl.play().then(()=>{ audioEl.pause(); audioEl.currentTime = 0; }).catch(()=>{});
    window.removeEventListener('pointerdown', primeOnce, true);
    window.removeEventListener('keydown',     primeOnce, true);
    window.removeEventListener('touchstart',  primeOnce, true);
  }
  window.addEventListener('pointerdown', primeOnce, true);
  window.addEventListener('keydown',     primeOnce, true);
  window.addEventListener('touchstart',  primeOnce, true);

  // ---------- CONFETTI ----------
  const colorHexMap = {
    Red:'#e74c3c', Blue:'#3498db', Green:'#27ae60', Yellow:'#f39c12',
    Purple:'#9b59b6', Orange:'#e67e22', Pink:'#e91e63', Brown:'#795548',
    Black:'#2c3e50', Gray:'#7f8c8d', Teal:'#009688', Navy:'#34495e'
  };
  function celebrate(key, colorName) {
    if (celebrated.has(key)) return;
    celebrated.add(key);
    if (confettiEnabled && typeof window.confetti === 'function') {
      const c = colorHexMap[colorName] || '#22d3ee';
      const colors = [c, '#ffffff'];
      window.confetti({ particleCount: 90, spread: 70, origin: { y: 0.6 }, colors });
      window.confetti({ particleCount: 60, angle: 60,  spread: 55, origin: { x: 0 }, colors });
      window.confetti({ particleCount: 60, angle: 120, spread: 55, origin: { x: 1 }, colors });
    }
    playWinSound();
  }

  // ---------- DETECTION (Observer + polling fallback) ----------
  const container = document.getElementById('calledTickets');
  if (!container) { console.warn('[win-effects] #calledTickets not found.'); return; }

  function keyFromNode(node) {
    const num   = node.querySelector('.ticket-number')?.textContent?.trim() || '';
    const color = node.querySelector('.ticket-color')?.textContent?.trim() || '';
    return { key: `${color}::${num}`, color };
  }
  function scanAndCelebrate() {
    container.querySelectorAll('.ticket-item.winner').forEach(n => {
      const { key, color } = keyFromNode(n);
      if (key && !celebrated.has(key)) celebrate(key, color);
    });
  }

  scanAndCelebrate(); // initial (covers refresh)

  const obs = new MutationObserver(muts => {
    let changed = false;
    muts.forEach(m => m.addedNodes.forEach(n => {
      if (n.nodeType !== 1) return;
      if (n.classList?.contains('ticket-item') || n.querySelector?.('.ticket-item')) changed = true;
    }));
    if (changed) scanAndCelebrate();
  });
  obs.observe(container, { childList: true, subtree: true });

  setInterval(scanAndCelebrate, 600); // polling fallback

  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') scanAndCelebrate();
  });
})();
</script>

</body>
</html>
